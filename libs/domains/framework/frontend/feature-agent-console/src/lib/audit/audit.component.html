<div class="audit-container d-flex flex-column h-100">
  <!-- Fixed top area: filters -->
  <div class="audit-filters border-bottom bg-body-tertiary flex-shrink-0">
    <div class="p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold" i18n="@@featureAudit-filtersTitle">Filters</h5>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary d-md-none"
          [attr.aria-expanded]="!filtersCollapsed()"
          [attr.aria-controls]="'auditFiltersCollapse'"
          [attr.data-bs-target]="'#auditFiltersCollapse'"
          data-bs-toggle="collapse"
          (click)="onToggleFilters()"
          i18n-title="@@featureAudit-toggleFiltersTitle"
          title="Toggle filters"
        >
          <i class="bi" [class.bi-chevron-down]="filtersCollapsed()" [class.bi-chevron-up]="!filtersCollapsed()"></i>
        </button>
      </div>
      <div class="collapse d-md-block mt-2" id="auditFiltersCollapse">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label for="auditClientSelect" class="form-label small" i18n="@@featureAudit-clientLabel">Client</label>
            <select
              id="auditClientSelect"
              class="form-select form-select-sm"
              [ngModel]="selectedClientId()"
              (ngModelChange)="selectedClientId.set($event)"
            >
              <option [ngValue]="null" i18n="@@featureAudit-allClients">All clients</option>
              @for (client of clients(); track client.id) {
                <option [ngValue]="client.id">{{ client.name }}</option>
              }
            </select>
          </div>
          <div class="col-12 col-md-2">
            <label for="auditFromDate" class="form-label small" i18n="@@featureAudit-fromDateLabel">From</label>
            <input
              id="auditFromDate"
              type="date"
              class="form-control form-control-sm"
              [ngModel]="fromDate()"
              (ngModelChange)="fromDate.set($event)"
            />
          </div>
          <div class="col-12 col-md-2">
            <label for="auditToDate" class="form-label small" i18n="@@featureAudit-toDateLabel">To</label>
            <input
              id="auditToDate"
              type="date"
              class="form-control form-control-sm"
              [ngModel]="toDate()"
              (ngModelChange)="toDate.set($event)"
            />
          </div>
          <div class="col-12 col-md-2">
            <label for="auditGroupBy" class="form-label small" i18n="@@featureAudit-groupByLabel">Group by</label>
            <select
              id="auditGroupBy"
              class="form-select form-select-sm"
              [ngModel]="groupBy()"
              (ngModelChange)="groupBy.set($event)"
            >
              <option value="day" i18n="@@featureAudit-groupByDay">Day</option>
              <option value="hour" i18n="@@featureAudit-groupByHour">Hour</option>
            </select>
          </div>
          <div class="col-12 col-md-2 offset-md-1 d-flex align-items-end">
            <button
              type="button"
              class="btn btn-primary btn-sm w-100"
              (click)="onApplyFilters()"
              [disabled]="(loadingSummary$ | async) === true"
            >
              @if (loadingSummary$ | async) {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              } @else {
                <span i18n="@@featureAudit-apply">Apply</span>
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scrollable content area -->
  <div class="audit-content flex-grow-1 overflow-auto">
    @let summaryData = summary();
    @if (error$ | async; as error) {
      <div class="alert alert-danger m-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ error }}
      </div>
    } @else if (loadingSummary$ | async) {
      <div class="d-flex justify-content-center align-items-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden" i18n="@@featureAudit-loading">Loading statistics...</span>
        </div>
      </div>
    } @else if (summaryData) {
      <!-- Summary cards -->
      <div class="p-3">
        <div class="row g-3 mb-4">
          <div class="col-6 col-md">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureAudit-totalMessages">Total messages</h6>
                <p class="card-title mb-0 fs-4 fw-bold">{{ summaryData.totalMessages }}</p>
              </div>
            </div>
          </div>
          <div class="col-6 col-md">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureAudit-totalWords">Total words</h6>
                <p class="card-title mb-0 fs-4 fw-bold">{{ summaryData.totalWords }}</p>
              </div>
            </div>
          </div>
          <div class="col-6 col-md">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureAudit-avgWordsPerMessage">
                  Avg words/message
                </h6>
                <p class="card-title mb-0 fs-4 fw-bold">{{ summaryData.avgWordsPerMessage | number: '1.1-1' }}</p>
              </div>
            </div>
          </div>
          <div class="col-6 col-md">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureAudit-filterFlags">Filter flags</h6>
                <p class="card-title mb-0 fs-4 fw-bold">{{ summaryData.filterFlagCount }}</p>
              </div>
            </div>
          </div>
          <div class="col-6 col-md">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureAudit-filterDrops">Filter drops</h6>
                <p class="card-title mb-0 fs-4 fw-bold">{{ summaryData.filterDropCount }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts row -->
        <div class="row g-3">
          @if (seriesChartOptions(); as chartOpts) {
            <div class="col-12 col-lg-8">
              <div class="card">
                <div class="card-body">
                  <apx-chart
                    [series]="chartOpts.series"
                    [chart]="chartOpts.chart"
                    [colors]="chartOpts.colors"
                    [stroke]="chartOpts.stroke"
                    [fill]="chartOpts.fill"
                    [xaxis]="chartOpts.xaxis"
                    [yaxis]="chartOpts.yaxis"
                    [grid]="chartOpts.grid"
                    [title]="chartOpts.title"
                  ></apx-chart>
                </div>
              </div>
            </div>
          }
          @if (filterBreakdownChartOptions(); as donutOpts) {
            <div class="col-12" [class.col-lg-4]="seriesChartOptions()">
              <div class="card">
                <div class="card-body">
                  <apx-chart
                    [series]="donutOpts.series"
                    [chart]="donutOpts.chart"
                    [colors]="donutOpts.colors"
                    [labels]="donutOpts.labels"
                    [legend]="donutOpts.legend"
                    [title]="donutOpts.title"
                  ></apx-chart>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Tables section -->
        <div class="mt-4">
          <h6 class="fw-semibold mb-3" i18n="@@featureAudit-auditTables">Audit Tables</h6>

          <!-- Chat I/O Table -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span i18n="@@featureAudit-chatIoTable">Chat I/O</span>
              <div class="input-group input-group-sm" style="max-width: 200px">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search"
                  i18n-placeholder="@@featureAudit-searchPlaceholder"
                  [ngModel]="chatIoSearch()"
                  (ngModelChange)="onChatIoSearchChange($event)"
                />
              </div>
            </div>
            <div class="card-body p-0">
              @if (loadingChatIo$ | async) {
                <div class="text-center py-4">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr>
                        <th i18n="@@featureAudit-time">Time</th>
                        <th i18n="@@featureAudit-user">User</th>
                        <th i18n="@@featureAudit-agent">Agent</th>
                        <th i18n="@@featureAudit-direction">Direction</th>
                        <th i18n="@@featureAudit-words">Words</th>
                        <th i18n="@@featureAudit-chars">Chars</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of chatIo()?.data ?? []; track row.id) {
                        <tr>
                          <td>{{ formatDateTime(row.occurredAt) }}</td>
                          <td>{{ resolveUserDisplay(row.originalUserId) }}</td>
                          <td>
                            @if (buildAgentChatRoute(row.clientId, row.agentId); as route) {
                              <a
                                [routerLink]="route"
                                [innerHTML]="resolveAgentDisplay(row)"
                                class="text-decoration-none"
                              ></a>
                            } @else {
                              <span [innerHTML]="resolveAgentDisplay(row)"></span>
                            }
                          </td>
                          <td>
                            <span
                              class="badge"
                              [class.bg-primary]="row.direction === 'input'"
                              [class.bg-secondary]="row.direction === 'output'"
                              >{{ row.direction }}</span
                            >
                          </td>
                          <td>{{ row.wordCount }}</td>
                          <td>{{ row.charCount }}</td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="6" class="text-center text-muted py-3" i18n="@@featureAudit-noRows">No rows</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
            @if (chatIo(); as list) {
              <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" i18n="@@featureAudit-showingOf"
                  >Showing {{ list.data.length }} of {{ list.total }}</small
                >
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="chatIoPage() <= 0">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onChatIoPageChange(chatIoPage() - 1); $event.preventDefault()"
                        i18n="@@featureAudit-prev"
                        >Previous</a
                      >
                    </li>
                    <li class="page-item disabled">
                      <span class="page-link">{{ chatIoPage() + 1 }} / {{ totalPages(list.total) || 1 }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="chatIoPage() >= totalPages(list.total) - 1">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onChatIoPageChange(chatIoPage() + 1); $event.preventDefault()"
                        i18n="@@featureAudit-next"
                        >Next</a
                      >
                    </li>
                  </ul>
                </nav>
              </div>
            }
          </div>

          <!-- Filter Drops Table -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span i18n="@@featureAudit-filterDropsTable">Filter Drops</span>
              <div class="input-group input-group-sm" style="max-width: 200px">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search"
                  i18n-placeholder="@@featureAudit-searchPlaceholder"
                  [ngModel]="filterDropsSearch()"
                  (ngModelChange)="onFilterDropsSearchChange($event)"
                />
              </div>
            </div>
            <div class="card-body p-0">
              @if (loadingFilterDrops$ | async) {
                <div class="text-center py-4">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr>
                        <th i18n="@@featureAudit-time">Time</th>
                        <th i18n="@@featureAudit-user">User</th>
                        <th i18n="@@featureAudit-agent">Agent</th>
                        <th i18n="@@featureAudit-filterType">Filter</th>
                        <th i18n="@@featureAudit-direction">Direction</th>
                        <th i18n="@@featureAudit-words">Words</th>
                        <th i18n="@@featureAudit-reason">Reason</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of filterDrops()?.data ?? []; track row.id) {
                        <tr>
                          <td>{{ formatDateTime(row.occurredAt) }}</td>
                          <td>{{ resolveUserDisplay(row.originalUserId) }}</td>
                          <td>
                            @if (buildAgentChatRoute(row.clientId, row.agentId); as route) {
                              <a
                                [routerLink]="route"
                                [innerHTML]="resolveAgentDisplay(row)"
                                class="text-decoration-none"
                              ></a>
                            } @else {
                              <span [innerHTML]="resolveAgentDisplay(row)"></span>
                            }
                          </td>
                          <td>{{ row.filterDisplayName }}</td>
                          <td>
                            <span
                              class="badge"
                              [class.bg-primary]="row.direction === 'incoming'"
                              [class.bg-secondary]="row.direction === 'outgoing'"
                              >{{ row.direction }}</span
                            >
                          </td>
                          <td>{{ row.wordCount }}</td>
                          <td>{{ row.filterReason ?? '-' }}</td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="7" class="text-center text-muted py-3" i18n="@@featureAudit-noRows">No rows</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
            @if (filterDrops(); as list) {
              <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" i18n="@@featureAudit-showingOf"
                  >Showing {{ list.data.length }} of {{ list.total }}</small
                >
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="filterDropsPage() <= 0">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onFilterDropsPageChange(filterDropsPage() - 1); $event.preventDefault()"
                        i18n="@@featureAudit-prev"
                        >Previous</a
                      >
                    </li>
                    <li class="page-item disabled">
                      <span class="page-link">{{ filterDropsPage() + 1 }} / {{ totalPages(list.total) || 1 }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="filterDropsPage() >= totalPages(list.total) - 1">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onFilterDropsPageChange(filterDropsPage() + 1); $event.preventDefault()"
                        i18n="@@featureAudit-next"
                        >Next</a
                      >
                    </li>
                  </ul>
                </nav>
              </div>
            }
          </div>

          <!-- Filter Flags Table -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span i18n="@@featureAudit-filterFlagsTable">Filter Flags</span>
              <div class="input-group input-group-sm" style="max-width: 200px">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search"
                  i18n-placeholder="@@featureAudit-searchPlaceholder"
                  [ngModel]="filterFlagsSearch()"
                  (ngModelChange)="onFilterFlagsSearchChange($event)"
                />
              </div>
            </div>
            <div class="card-body p-0">
              @if (loadingFilterFlags$ | async) {
                <div class="text-center py-4">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr>
                        <th i18n="@@featureAudit-time">Time</th>
                        <th i18n="@@featureAudit-user">User</th>
                        <th i18n="@@featureAudit-agent">Agent</th>
                        <th i18n="@@featureAudit-filterType">Filter</th>
                        <th i18n="@@featureAudit-direction">Direction</th>
                        <th i18n="@@featureAudit-words">Words</th>
                        <th i18n="@@featureAudit-reason">Reason</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of filterFlags()?.data ?? []; track row.id) {
                        <tr>
                          <td>{{ formatDateTime(row.occurredAt) }}</td>
                          <td>{{ resolveUserDisplay(row.originalUserId) }}</td>
                          <td>
                            @if (buildAgentChatRoute(row.clientId, row.agentId); as route) {
                              <a
                                [routerLink]="route"
                                [innerHTML]="resolveAgentDisplay(row)"
                                class="text-decoration-none"
                              ></a>
                            } @else {
                              <span [innerHTML]="resolveAgentDisplay(row)"></span>
                            }
                          </td>
                          <td>{{ row.filterDisplayName }}</td>
                          <td>
                            <span
                              class="badge"
                              [class.bg-primary]="row.direction === 'incoming'"
                              [class.bg-secondary]="row.direction === 'outgoing'"
                              >{{ row.direction }}</span
                            >
                          </td>
                          <td>{{ row.wordCount }}</td>
                          <td>{{ row.filterReason ?? '-' }}</td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="7" class="text-center text-muted py-3" i18n="@@featureAudit-noRows">No rows</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
            @if (filterFlags(); as list) {
              <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" i18n="@@featureAudit-showingOf"
                  >Showing {{ list.data.length }} of {{ list.total }}</small
                >
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="filterFlagsPage() <= 0">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onFilterFlagsPageChange(filterFlagsPage() - 1); $event.preventDefault()"
                        i18n="@@featureAudit-prev"
                        >Previous</a
                      >
                    </li>
                    <li class="page-item disabled">
                      <span class="page-link">{{ filterFlagsPage() + 1 }} / {{ totalPages(list.total) || 1 }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="filterFlagsPage() >= totalPages(list.total) - 1">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onFilterFlagsPageChange(filterFlagsPage() + 1); $event.preventDefault()"
                        i18n="@@featureAudit-next"
                        >Next</a
                      >
                    </li>
                  </ul>
                </nav>
              </div>
            }
          </div>

          <!-- Entity Events Table -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              <span i18n="@@featureAudit-entityEventsTable">Entity Events</span>
              <div class="input-group input-group-sm" style="max-width: 200px">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search"
                  i18n-placeholder="@@featureAudit-searchPlaceholder"
                  [ngModel]="entityEventsSearch()"
                  (ngModelChange)="onEntityEventsSearchChange($event)"
                />
              </div>
            </div>
            <div class="card-body p-0">
              @if (loadingEntityEvents$ | async) {
                <div class="text-center py-4">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr>
                        <th i18n="@@featureAudit-time">Time</th>
                        <th i18n="@@featureAudit-user">User</th>
                        <th i18n="@@featureAudit-entityType">Type</th>
                        <th i18n="@@featureAudit-entity">Entity</th>
                        <th i18n="@@featureAudit-eventType">Event</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of entityEvents()?.data ?? []; track row.id) {
                        <tr>
                          <td>{{ formatDateTime(row.occurredAt) }}</td>
                          <td>{{ resolveUserDisplay(row.originalUserId) }}</td>
                          <td>{{ row.entityType }}</td>
                          <td>
                            @if (buildEntityEventRoute(row); as route) {
                              <a
                                [routerLink]="route"
                                [innerHTML]="resolveEntityDisplay(row)"
                                class="text-decoration-none"
                              ></a>
                            } @else {
                              <span [innerHTML]="resolveEntityDisplay(row)"></span>
                            }
                          </td>
                          <td>
                            <span
                              class="badge"
                              [class.bg-success]="row.eventType === 'created'"
                              [class.bg-warning]="row.eventType === 'updated'"
                              [class.bg-danger]="row.eventType === 'deleted'"
                              [class.text-dark]="row.eventType === 'updated'"
                              >{{ row.eventType }}</span
                            >
                          </td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="6" class="text-center text-muted py-3" i18n="@@featureAudit-noRows">No rows</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
            @if (entityEvents(); as list) {
              <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" i18n="@@featureAudit-showingOf"
                  >Showing {{ list.data.length }} of {{ list.total }}</small
                >
                <nav>
                  <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" [class.disabled]="entityEventsPage() <= 0">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onEntityEventsPageChange(entityEventsPage() - 1); $event.preventDefault()"
                        i18n="@@featureAudit-prev"
                        >Previous</a
                      >
                    </li>
                    <li class="page-item disabled">
                      <span class="page-link">{{ entityEventsPage() + 1 }} / {{ totalPages(list.total) || 1 }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="entityEventsPage() >= totalPages(list.total) - 1">
                      <a
                        class="page-link"
                        href="#"
                        (click)="onEntityEventsPageChange(entityEventsPage() + 1); $event.preventDefault()"
                        i18n="@@featureAudit-next"
                        >Next</a
                      >
                    </li>
                  </ul>
                </nav>
              </div>
            }
          </div>
        </div>
      </div>
    } @else if (!(loadingSummary$ | async) && !(error$ | async)) {
      <div class="d-flex justify-content-center align-items-center p-5">
        <div class="text-center text-muted">
          <i class="bi bi-graph-up fs-1 d-block mb-2"></i>
          <p class="mb-0" i18n="@@featureAudit-noData">No data yet. Apply filters and load statistics.</p>
        </div>
      </div>
    }
  </div>
</div>
