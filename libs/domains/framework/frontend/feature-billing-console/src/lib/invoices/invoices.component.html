<div class="invoices-container border-top d-flex flex-column h-100">
  <div class="invoices-header p-3 border-bottom bg-body-tertiary d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fw-semibold" i18n="@@featureInvoices-title">Billing</h5>
  </div>
  <div class="p-3 flex-grow-1 overflow-auto">
    @if (invoicesError$ | async; as err) {
      <div class="alert alert-danger" role="alert">{{ err }}</div>
    }

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureInvoices-openOverdueCount">
              Open and overdue invoices
            </h6>
            @if (invoicesSummaryLoading$ | async) {
              <p class="card-title mb-0 fs-4 fw-bold">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </p>
            } @else {
              @if (invoicesSummary$ | async; as summary) {
                <p class="card-title mb-0 fs-4 fw-bold">{{ summary.openOverdueCount }}</p>
              } @else {
                <p class="card-title mb-0 fs-4 fw-bold text-body-secondary">—</p>
              }
            }
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-1 text-muted small" i18n="@@featureInvoices-openOverdueTotal">
              Open total amount
            </h6>
            @if (invoicesSummaryLoading$ | async) {
              <p class="card-title mb-0 fs-4 fw-bold">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </p>
            } @else {
              @if (invoicesSummary$ | async; as summary) {
                <p class="card-title mb-0 fs-4 fw-bold">{{ summary.openOverdueTotal | number: '1.2-2' }}€</p>
              } @else {
                <p class="card-title mb-0 fs-4 fw-bold text-body-secondary">—</p>
              }
            }
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span class="py-1" i18n="@@featureInvoices-openOverdueList">Open and overdue invoices</span>
      </div>
      <div class="card-body p-0">
        @if (openOverdueListLoading$ | async) {
          <div class="p-3 d-flex align-items-center gap-2">
            <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
            <span i18n="@@featureInvoices-loadingOpenOverdue">Loading open and overdue invoices...</span>
          </div>
        } @else {
          @if (openOverdueListError$ | async; as listErr) {
            <div class="p-3">
              <div class="alert alert-warning mb-0" role="alert">{{ listErr }}</div>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead>
                  <tr>
                    <th scope="col" i18n="@@featureInvoices-subscription">Subscription</th>
                    <th scope="col" i18n="@@featureInvoices-id">Invoice number</th>
                    <th scope="col" i18n="@@featureInvoices-status">Status</th>
                    <th scope="col" i18n="@@featureInvoices-date">Date</th>
                    <th scope="col" i18n="@@featureInvoices-amount">Amount</th>
                    <th scope="col" i18n="@@featureInvoices-link">Link</th>
                  </tr>
                </thead>
                <tbody>
                  @for (inv of openOverdueList$ | async; track inv.id) {
                    <tr>
                      <td>{{ inv.subscriptionNumber ?? '—' }}</td>
                      <td>{{ inv.invoiceNumber ?? '—' }}</td>
                      <td>
                        <span class="badge bg-secondary">{{ getInvoiceStatus(inv.status) ?? '—' }}</span>
                      </td>
                      <td>{{ inv.createdAt | date: 'short' }}</td>
                      <td>{{ inv.balance != null ? (inv.balance | number: '1.2-2') + ' €' : '—' }}</td>
                      <td>
                        @if ((refreshingInvoiceRefId$ | async) === inv.id) {
                          <span class="d-inline-flex align-items-center gap-1" aria-busy="true">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span i18n="@@featureInvoices-opening">Opening…</span>
                          </span>
                        } @else {
                          <button
                            type="button"
                            class="btn btn-primary btn-sm"
                            (click)="openInvoiceLinkForRef(inv.subscriptionId, inv)"
                            i18n="@@featureInvoices-openLink"
                          >
                            Open
                          </button>
                        }
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="6" class="text-body-secondary" i18n="@@featureInvoices-noOpenOverdue">
                        No open or overdue invoices.
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }
      </div>
    </div>

    <div class="mb-4">
      <label for="subscriptionSelect" class="form-label" i18n="@@featureInvoices-selectSubscription"
        >Subscription</label
      >
      <select
        id="subscriptionSelect"
        name="subscriptionId"
        class="form-select"
        [ngModel]="selectedSubscriptionId"
        (ngModelChange)="onSelectSubscription($event)"
        [disabled]="(subscriptions$ | async)?.length === 0"
      >
        <option value="" i18n="@@featureInvoices-chooseSubscription">Choose a subscription</option>
        @for (sub of subscriptions$ | async; track sub.id) {
          <option [value]="sub.id">
            @if (servicePlans$ | async; as plans) {
              {{ sub.number || '—' }} – {{ planNameByPlanId(sub.planId, plans) }} ({{ sub.status }})
            } @else {
              {{ sub.number || '—' }} – {{ sub.planId }} ({{ sub.status }})
            }
          </option>
        }
      </select>
    </div>

    @if (selectedSubscriptionId) {
      @if (invoicesLoading$ | async) {
        <div class="d-flex align-items-center gap-2 mb-3">
          <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
          <span i18n="@@featureInvoices-loading">Loading invoices...</span>
        </div>
      } @else {
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="py-1" i18n="@@featureInvoices-invoices">Invoices</span>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead>
                  <tr>
                    <th scope="col" i18n="@@featureInvoices-id">Invoice number</th>
                    <th scope="col" i18n="@@featureInvoices-status">Status</th>
                    <th scope="col" i18n="@@featureInvoices-date">Date</th>
                    <th scope="col" i18n="@@featureInvoices-amount">Amount</th>
                    <th scope="col" i18n="@@featureInvoices-link">Link</th>
                  </tr>
                </thead>
                <tbody>
                  @for (inv of paginatedInvoices(); track inv.id) {
                    <tr>
                      <td>{{ inv.invoiceNumber || '—' }}</td>
                      <td>
                        <span class="badge bg-secondary">{{ getInvoiceStatus(inv.status) ?? '—' }}</span>
                      </td>
                      <td>{{ inv.createdAt | date: 'short' }}</td>
                      <td>{{ inv.balance != null ? (inv.balance | number: '1.2-2') + ' €' : '—' }}</td>
                      <td>
                        @if ((refreshingInvoiceRefId$ | async) === inv.id) {
                          <span class="d-inline-flex align-items-center gap-1" aria-busy="true">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span i18n="@@featureInvoices-opening">Opening…</span>
                          </span>
                        } @else {
                          <button
                            type="button"
                            class="btn btn-link link-primary p-0 text-start"
                            (click)="openInvoiceLink(inv)"
                            i18n="@@featureInvoices-openLink"
                          >
                            Open
                          </button>
                        }
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="5" class="text-body-secondary" i18n="@@featureInvoices-noInvoices">
                        No invoices for this subscription.
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          @if (allInvoices()) {
            <div class="card-footer d-flex justify-content-between align-items-center">
              <small class="text-muted" i18n="@@featureInvoices-showingOf"
                >Showing {{ paginatedInvoices().length }} of {{ allInvoices().length }}</small
              >
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="invoicesPage() <= 0">
                    <a
                      class="page-link"
                      href="#"
                      (click)="onInvoicesPageChange(invoicesPage() - 1); $event.preventDefault()"
                      i18n="@@featureInvoices-prev"
                      >Previous</a
                    >
                  </li>
                  <li class="page-item disabled">
                    <span class="page-link">{{ invoicesPage() + 1 }} / {{ invoicesTotalPages() }}</span>
                  </li>
                  <li class="page-item" [class.disabled]="invoicesPage() >= invoicesTotalPages() - 1">
                    <a
                      class="page-link"
                      href="#"
                      (click)="onInvoicesPageChange(invoicesPage() + 1); $event.preventDefault()"
                      i18n="@@featureInvoices-next"
                      >Next</a
                    >
                  </li>
                </ul>
              </nav>
            </div>
          }
        </div>
      }
    } @else {
      <p class="text-body-secondary" i18n="@@featureInvoices-selectFirst">Select a subscription to view invoices.</p>
    }
  </div>
</div>
