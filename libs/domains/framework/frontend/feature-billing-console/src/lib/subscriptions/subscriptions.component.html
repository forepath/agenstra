<div class="subscriptions-container border-top d-flex flex-column h-100">
  <div
    class="subscriptions-header p-3 border-bottom bg-body-tertiary d-flex justify-content-between align-items-center"
  >
    <h5 class="mb-0 fw-semibold" i18n="@@featureSubscriptions-title">Plans &amp; Subscriptions</h5>
    <button
      type="button"
      class="btn btn-primary btn-sm"
      (click)="openOrderPlanModal()"
      i18n="@@featureSubscriptions-orderPlan"
    >
      Order
    </button>
  </div>
  <div class="p-3 flex-grow-1 overflow-auto">
    @if (subscriptionsError$ | async; as err) {
      <div class="alert alert-danger" role="alert">{{ err }}</div>
    }
    @if (backordersError$ | async; as err) {
      <div class="alert alert-danger" role="alert">{{ err }}</div>
    }

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0" i18n="@@featureSubscriptions-mySubscriptions">My subscriptions</h2>
    </div>

    @if (subscriptionsLoading$ | async) {
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span i18n="@@featureSubscriptions-loading">Loading subscriptions...</span>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col" i18n="@@featureSubscriptions-plan">Plan</th>
              <th scope="col" i18n="@@featureSubscriptions-status">Status</th>
              <th scope="col" i18n="@@featureSubscriptions-period">Period</th>
              <th scope="col" i18n="@@featureSubscriptions-nextBilling">Next billing</th>
              <th scope="col" i18n="@@featureSubscriptions-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (sub of subscriptions$ | async; track sub.id) {
              <tr>
                <td>
                  @if (servicePlans$ | async; as plans) {
                    {{ planNameByPlanId(plans, sub.planId) }}
                  } @else {
                    {{ sub.planId }}
                  }
                </td>
                <td>
                  <span class="badge bg-secondary">{{ sub.status }}</span>
                </td>
                <td>
                  @if (sub.currentPeriodStart && sub.currentPeriodEnd) {
                    {{ sub.currentPeriodStart | date: 'shortDate' }} – {{ sub.currentPeriodEnd | date: 'shortDate' }}
                  } @else {
                    —
                  }
                </td>
                <td>{{ sub.nextBillingAt ? (sub.nextBillingAt | date: 'shortDate') : '—' }}</td>
                <td>
                  @if (sub.status === 'active') {
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger me-1"
                      (click)="openCancelConfirm(sub)"
                      i18n="@@featureSubscriptions-cancel"
                    >
                      Cancel
                    </button>
                  }
                  @if (sub.status === 'pending_cancel') {
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-success"
                      (click)="openResumeConfirm(sub)"
                      i18n="@@featureSubscriptions-resume"
                    >
                      Resume
                    </button>
                  }
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="5" class="text-body-secondary" i18n="@@featureSubscriptions-noSubscriptions">
                  No subscriptions yet.
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <h2 class="h5 mt-4 mb-3" i18n="@@featureSubscriptions-backorders">Backorders</h2>
    @if (backordersLoading$ | async) {
      <div class="d-flex align-items-center gap-2 mb-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span i18n="@@featureSubscriptions-loadingBackorders">Loading backorders...</span>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col" i18n="@@featureSubscriptions-plan">Plan</th>
              <th scope="col" i18n="@@featureSubscriptions-status">Status</th>
              <th scope="col" i18n="@@featureSubscriptions-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (bo of pendingBackorders$ | async; track bo.id) {
              <tr>
                <td>{{ bo.planId }}</td>
                <td>
                  <span class="badge bg-warning text-dark">{{ bo.status }}</span>
                </td>
                <td>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary me-1"
                    (click)="retryBackorder(bo)"
                    i18n="@@featureSubscriptions-retry"
                  >
                    Retry
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    (click)="openCancelBackorderConfirm(bo)"
                    i18n="@@featureSubscriptions-cancel"
                  >
                    Cancel
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="3" class="text-body-secondary" i18n="@@featureSubscriptions-noBackorders">
                  No pending backorders.
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <h2 class="h5 mt-4 mb-3" i18n="@@featureSubscriptions-customerProfile">Customer profile</h2>
    <p class="text-body-secondary mb-2" i18n="@@featureSubscriptions-customerProfileHint">
      Required for invoicing. Please complete your profile with first name, last name, email, address, city and country.
    </p>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      @if (isCustomerProfileComplete$ | async) {
        <span class="badge bg-success" i18n="@@featureSubscriptions-profileComplete">Complete</span>
      } @else {
        <span class="badge bg-warning text-dark" i18n="@@featureSubscriptions-profileIncomplete">Incomplete</span>
      }
      <button
        type="button"
        class="btn btn-outline-primary btn-sm"
        (click)="openEditProfileModal()"
        [disabled]="(customerProfileUpdating$ | async) === true"
        i18n="@@featureSubscriptions-editProfile"
      >
        Edit profile
      </button>
    </div>
  </div>
</div>

<!-- Order plan modal -->
<div
  class="modal fade"
  id="orderPlanModal"
  tabindex="-1"
  aria-labelledby="orderPlanModalLabel"
  aria-hidden="true"
  #orderPlanModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderPlanModalLabel" i18n="@@featureSubscriptions-orderPlan">Order plan</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          [disabled]="(subscriptionsCreating$ | async) === true"
        ></button>
      </div>
      <form (ngSubmit)="onSubmitOrderPlan()" #orderForm="ngForm">
        <div class="modal-body">
          <div class="mb-3">
            <div class="card bg-body-tertiary">
              <div class="card-body">
                <label for="orderPlanId" class="form-label mt-0" i18n="@@featureSubscriptions-selectPlan">Plan</label>
                <select
                  id="orderPlanId"
                  name="planId"
                  class="form-select"
                  [(ngModel)]="orderPlanId"
                  required
                  [disabled]="(subscriptionsCreating$ | async) === true || (servicePlansLoading$ | async) === true"
                >
                  <option value="" i18n="@@featureSubscriptions-choosePlan">Choose a plan</option>
                  @for (plan of servicePlans$ | async; track plan.id) {
                    <option [value]="plan.id">{{ formatPlanOptionLabel(plan) }}</option>
                  }
                </select>
                @if (orderPlanId && (servicePlans$ | async); as plans) {
                  @if (getSelectedPlan(plans, orderPlanId); as selectedPlan) {
                    @if (selectedPlan.description?.trim()) {
                      <div
                        class="mt-3 text-body-secondary small p-3 bg-body border rounded"
                        style="white-space: pre-wrap"
                        [innerHTML]="selectedPlan.description"
                      ></div>
                    }
                    <div class="mt-3 p-3 bg-body border rounded">
                      <div class="text-body-secondary small">
                        <span i18n="@@featureSubscriptions-price">Price</span>
                        <strong class="ms-2">{{ formatPlanPrice(selectedPlan) }}</strong>
                      </div>
                      <div class="text-body-secondary small">
                        <span i18n="@@featureSubscriptions-billingInterval">Runtime</span>
                        <strong class="ms-2"
                          >{{ selectedPlan.billingIntervalValue }} {{ selectedPlan.billingIntervalType }}(s)</strong
                        >
                      </div>
                      <div class="text-body-secondary small">
                        <span i18n="@@featureSubscriptions-minCommitment">Min. commitment</span>
                        <strong class="ms-2"
                          >{{ selectedPlan.minCommitmentDays }}
                          <span i18n="@@featureSubscriptions-days">days</span></strong
                        >
                      </div>
                      <div class="text-body-secondary small">
                        <span i18n="@@featureSubscriptions-noticeDays">Notice period</span>
                        <strong class="ms-2"
                          >{{ selectedPlan.noticeDays }} <span i18n="@@featureSubscriptions-days">days</span></strong
                        >
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="orderAutoBackorder"
              name="autoBackorder"
              [(ngModel)]="orderAutoBackorder"
              [disabled]="(subscriptionsCreating$ | async) === true"
            />
            <label class="form-check-label" for="orderAutoBackorder" i18n="@@featureSubscriptions-autoBackorder"
              >Auto backorder if unavailable</label
            >
          </div>
          <div class="form-check mt-3">
            <input
              type="checkbox"
              class="form-check-input"
              id="orderAcceptLegal"
              name="acceptLegal"
              [(ngModel)]="orderAcceptLegal"
              required
              [disabled]="(subscriptionsCreating$ | async) === true"
            />
            <label class="form-check-label" for="orderAcceptLegal">
              <span i18n="@@featureSubscriptions-acceptLegalPrefix">I have read and accept the</span>
              <a
                [href]="termsUrl"
                target="_blank"
                rel="noopener noreferrer"
                class="ms-1"
                i18n="@@featureSubscriptions-termsLink"
                >Terms and Conditions</a
              ><span> &amp; </span
              ><a
                [href]="privacyUrl"
                target="_blank"
                rel="noopener noreferrer"
                class="ms-1"
                i18n="@@featureSubscriptions-privacyLink"
                >Privacy Policy</a
              >.
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" i18n="@@featureSubscriptions-close">
            Close
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!orderPlanId.trim() || !orderAcceptLegal || (subscriptionsCreating$ | async) === true"
            i18n="@@featureSubscriptions-submitOrder"
          >
            Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel subscription confirm -->
<div
  class="modal fade"
  id="cancelSubscriptionModal"
  tabindex="-1"
  aria-labelledby="cancelSubscriptionModalLabel"
  aria-hidden="true"
  #cancelSubscriptionModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelSubscriptionModalLabel" i18n="@@featureSubscriptions-cancelSubscriptionTitle">
          Cancel subscription?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p i18n="@@featureSubscriptions-cancelSubscriptionConfirm">
          Are you sure you want to cancel this subscription? It will remain active until the end of the current period.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" i18n="@@featureSubscriptions-close">
          Close
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="confirmCancelSubscription()"
          i18n="@@featureSubscriptions-confirmCancel"
        >
          Confirm cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Resume subscription confirm -->
<div
  class="modal fade"
  id="resumeConfirmModal"
  tabindex="-1"
  aria-labelledby="resumeConfirmModalLabel"
  aria-hidden="true"
  #resumeConfirmModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resumeConfirmModalLabel" i18n="@@featureSubscriptions-resumeSubscriptionTitle">
          Resume subscription?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p i18n="@@featureSubscriptions-resumeSubscriptionConfirm">
          Resume this subscription so it continues after the current period.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" i18n="@@featureSubscriptions-close">
          Close
        </button>
        <button
          type="button"
          class="btn btn-success"
          (click)="confirmResume()"
          i18n="@@featureSubscriptions-confirmResume"
        >
          Resume
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cancel backorder confirm -->
<div
  class="modal fade"
  id="cancelBackorderModal"
  tabindex="-1"
  aria-labelledby="cancelBackorderModalLabel"
  aria-hidden="true"
  #cancelBackorderModal
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelBackorderModalLabel" i18n="@@featureSubscriptions-cancelBackorderTitle">
          Cancel backorder?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p i18n="@@featureSubscriptions-cancelBackorderConfirm">Are you sure you want to cancel this backorder?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" i18n="@@featureSubscriptions-close">
          Close
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="confirmCancelBackorder()"
          i18n="@@featureSubscriptions-confirmCancel"
        >
          Confirm cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit customer profile modal -->
<div
  class="modal fade"
  id="editProfileModal"
  tabindex="-1"
  aria-labelledby="editProfileModalLabel"
  aria-hidden="true"
  #editProfileModal
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel" i18n="@@featureSubscriptions-editProfileTitle">
          Edit customer profile
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          [disabled]="(customerProfileUpdating$ | async) === true"
        ></button>
      </div>
      <form (ngSubmit)="onSubmitProfile()">
        <div class="modal-body">
          @if (customerProfileError$ | async; as err) {
            <div class="alert alert-danger mb-3" role="alert">
              {{ err }}
            </div>
          }
          <p class="text-body-secondary small mb-3" i18n="@@featureSubscriptions-editProfileHint">
            First name, last name, email, address line 1, city and country are required for invoicing.
          </p>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="profileFirstName" class="form-label" i18n="@@featureSubscriptions-firstName"
                >First name</label
              >
              <input
                type="text"
                class="form-control"
                id="profileFirstName"
                name="firstName"
                [(ngModel)]="profileForm.firstName"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="profileLastName" class="form-label" i18n="@@featureSubscriptions-lastName">Last name</label>
              <input
                type="text"
                class="form-control"
                id="profileLastName"
                name="lastName"
                [(ngModel)]="profileForm.lastName"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
          </div>
          <div class="mb-3">
            <label for="profileCompany" class="form-label" i18n="@@featureSubscriptions-company">Company</label>
            <input
              type="text"
              class="form-control"
              id="profileCompany"
              name="company"
              [(ngModel)]="profileForm.company"
              [disabled]="(customerProfileUpdating$ | async) === true"
            />
          </div>
          <div class="mb-3">
            <label for="profileEmail" class="form-label" i18n="@@featureSubscriptions-email">Email</label>
            <input
              type="email"
              class="form-control"
              id="profileEmail"
              name="email"
              [(ngModel)]="profileForm.email"
              [disabled]="(customerProfileUpdating$ | async) === true"
            />
          </div>
          <div class="mb-3">
            <label for="profileAddressLine1" class="form-label" i18n="@@featureSubscriptions-addressLine1"
              >Address line 1</label
            >
            <input
              type="text"
              class="form-control"
              id="profileAddressLine1"
              name="addressLine1"
              [(ngModel)]="profileForm.addressLine1"
              [disabled]="(customerProfileUpdating$ | async) === true"
            />
          </div>
          <div class="mb-3">
            <label for="profileAddressLine2" class="form-label" i18n="@@featureSubscriptions-addressLine2"
              >Address line 2</label
            >
            <input
              type="text"
              class="form-control"
              id="profileAddressLine2"
              name="addressLine2"
              [(ngModel)]="profileForm.addressLine2"
              [disabled]="(customerProfileUpdating$ | async) === true"
            />
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="profilePostalCode" class="form-label" i18n="@@featureSubscriptions-postalCode"
                >Postal code</label
              >
              <input
                type="text"
                class="form-control"
                id="profilePostalCode"
                name="postalCode"
                [(ngModel)]="profileForm.postalCode"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="profileCity" class="form-label" i18n="@@featureSubscriptions-city">City</label>
              <input
                type="text"
                class="form-control"
                id="profileCity"
                name="city"
                [(ngModel)]="profileForm.city"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="profileState" class="form-label" i18n="@@featureSubscriptions-state">State / Region</label>
              <input
                type="text"
                class="form-control"
                id="profileState"
                name="state"
                [(ngModel)]="profileForm.state"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="profileCountry" class="form-label" i18n="@@featureSubscriptions-country">Country</label>
              <input
                type="text"
                class="form-control"
                id="profileCountry"
                name="country"
                [(ngModel)]="profileForm.country"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="profilePhone" class="form-label" i18n="@@featureSubscriptions-phone">Phone</label>
              <input
                type="text"
                class="form-control"
                id="profilePhone"
                name="phone"
                [(ngModel)]="profileForm.phone"
                [disabled]="(customerProfileUpdating$ | async) === true"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" i18n="@@featureSubscriptions-close">
            Close
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="(customerProfileUpdating$ | async) === true"
            i18n="@@featureSubscriptions-saveProfile"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
