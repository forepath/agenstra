sequenceDiagram
    participant Scheduler
    participant BackorderRetryService
    participant BackorderService
    participant AvailabilityService
    participant ProvisioningService
    participant Database

    Scheduler->>BackorderRetryService: processPendingBackorders()
    BackorderRetryService->>Database: SELECT backorders (pending/retrying)
    Database-->>BackorderRetryService: backorders

    loop Each backorder
        BackorderRetryService->>BackorderService: retry(backorderId)
        BackorderService->>AvailabilityService: checkAvailability
        AvailabilityService-->>BackorderService: availability result
        alt Available
            BackorderService->>Database: INSERT subscription + subscription_item
            BackorderService->>ProvisioningService: provision(provider, config)
            ProvisioningService-->>BackorderService: serverId
            BackorderService->>Database: UPDATE subscription_item.provider_reference
            BackorderService->>Database: UPDATE backorder status = fulfilled
        else Not available
            BackorderService->>Database: UPDATE backorder status = retrying
        end
    end
